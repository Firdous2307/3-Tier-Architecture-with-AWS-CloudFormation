AWSTemplateFormatVersion: '2010-09-09'
Description: Create EC2 Instances

Resources:
  #MyKeyPair:
  #  Type: 'AWS::EC2::KeyPair'
  #  Properties:
  #    KeyName: my-new-key-pair

  # Security group for the Test Server
  TestServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Test Server
      # Import the VPC ID from another stack (VPC-Stack)
      VpcId: !ImportValue 3tier-VPC
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
      Tags:
        - Key: Name
          Value: SecurityGroup1

  # Security group for PHP Server 1
  PHPServer1SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for PHP Server 1
      # Import the VPC ID from another stack (VPC-Stack)
      VpcId: !ImportValue 3tier-VPC
      # Allow inbound traffic from the Test Server's security group
      SecurityGroupIngress:
        - SourceSecurityGroupId: !Ref TestServerSecurityGroup
          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
      Tags:
        - Key: Name
          Value: PHPSecurityGroup1

  # EC2 instance for the Test Server in PublicSubnet1
  TestServerInstance:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: t2.micro
      ImageId: ami-08f3d5d5f119fbb31 # Amazon Linux 2 AMI
      KeyName: my-new-key-pair
      SubnetId: !ImportValue 3tier-PublicSubnet1
      SecurityGroupIds:
        - !Ref TestServerSecurityGroup
      Tags:
        - Key: Name
          Value: test-server

  # EC2 instance for PHP Server 1 in PrivateSubnet1
  PHPServer1Instance:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: t2.micro
      ImageId: ami-08f3d5d5f119fbb31 # Amazon Linux 2 AMI
      KeyName: my-new-key-pair
      SubnetId: !ImportValue 3tier-PrivateSubnet1
      SecurityGroupIds:
        - !Ref PHPServer1SecurityGroup
      Tags:
        - Key: Name
          Value: php-server-1

  # EC2 instance for PHP Server 2 in PrivateSubnet2
  PHPServer2Instance:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: t2.micro
      ImageId: ami-08f3d5d5f119fbb31 # Amazon Linux 2 AMI
      KeyName: my-new-key-pair
      SubnetId: !ImportValue 3tier-PrivateSubnet2
      SecurityGroupIds:
        - !Ref PHPServer1SecurityGroup  
      Tags:
        - Key: Name
          Value: php-server-2
